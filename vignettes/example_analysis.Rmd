---
title: "Example analysis"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Example analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# TODO

- [ ] What should we do about convergence warnings in mixed effect model 

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.align = "center",
  fig.width = 8,
  fig.height = 5
)
```

```{r data}
library(tidyverse)
library(surveyTools)
dat <- surveyTools::EQ5D5L_surveys |>
  dplyr::mutate(surveyID = factor(surveyID))

dat <- as_eq5d5l(
    dat,
    mobility = "mobility",
    self_care = "self_care",
    usual = "usual",
    pain = "pain",
    anxiety = "anxiety",
    respondentID = "respondentID",
    surveyID = "surveyID",
    vas = "vas"
)

add_utility(dat, type = "DSU", country = "UK", age = "age", sex = "sex") -> dat
```

<!-- Should we go into acute, like in the main article? -->

- Reference to using normal distribution from Frank's paper

```{r mixedModel}
lme4::lmer(.value ~ (1 | respondentID) + surveyID + sex + age, data = dat) -> fit

# Compare predictions to the actual value
dat |>
  dplyr::mutate(predict = predict(fit)) |>
  dplyr::rename(actual = .value) |>
  tidyr::gather(type, value, actual, predict) -> plot_dat

ggplot(plot_dat) +
  geom_line(aes(x = surveyID, y = value, group = respondentID), alpha = 0.1) +
  facet_grid(type ~ .) -> gg
#ggsave(gg, file = "fig.png")
gg
```

```{r additionalParameter}
dat |>
  dplyr::mutate(acute = surveyID %in% c(2)) -> dat
model <- .value ~ (1 + acute | respondentID) + surveyID + sex + age + sex:age
lme4::lmer(model, data = dat) -> fit2

# Compare predictions to the actual value
dat |>
  dplyr::mutate(predict = predict(fit2)) |>
  dplyr::rename(actual = .value) |>
  tidyr::gather(type, value, actual, predict) -> plot_dat

ggplot(plot_dat) +
  geom_line(aes(x = surveyID, y = value, group = respondentID), alpha = 0.1) +
  facet_grid(type ~ .) -> gg
#ggsave(gg, file = "fig.png")
gg
```


```{r bootstrap}
set.seed(1)
dat |>
  dplyr::select(respondentID) |>
  dplyr::distinct() -> respondents_dat

#seq(1, 1000) |> purrr::map(function(np_id) {
seq(1, 1000) |> 
  purrr::map(purrr::quietly(function(np_id) {
    respondents_dat |>
      dplyr::sample_n(1000, replace = T) |>
      dplyr::left_join(dat, by = "respondentID") -> boot_dat

    lme4::lmer(model, data = boot_dat) -> fit
    list(model = fit, np = as.numeric(np_id))
})) |> 
  purrr::keep(function(lst0) length(lst0$warnings) == 0) -> models

models |> purrr::imap(function(model, np_id) {
    summary(model$result$model)$coefficients |>
      tibble::as_tibble(rownames = "id") |>
      dplyr::mutate(np = np_id)
    }) |> 
  dplyr::bind_rows() -> coeff_dat

coeff_dat |>
  dplyr::group_by(id) |>
  dplyr::summarise(quant = c(0.025, 0.25, 0.5, 0.75, 0.975),
                   value = quantile(Estimate, quant),
                   sig = all(value < 0) || all(value > 0)
                   ) |>
  tidyr::spread(quant, value) |>
  dplyr::ungroup() -> table_dat
```

```{r qaly}
# Bootstrap the qalys
# Baseline and full health
```


# Playground below

```{r beta_distribution_on_utility, eval = F}
library(brms)
dat |>
  dplyr::mutate(acute = surveyID %in% c(2), v = 1 - .value) -> dat
#brm(bf(v ~ (1 + acute | respondentID) + surveyID + sex + age + sex:age), data = dat, family = Gamma) -> fitgamma
brm(bf(v ~ (1 + acute | respondentID) + surveyID + sex + age + sex:age), data = dat, family = lognormal) -> fitlnorm
qs::qsave(fitlnorm, "~/Downloads/fitlnorm.qs")
```


```{r explore_zero_inflated_bin, eval = F}
# All dimensions

c("usual", "mobility", "self_care", "pain", "anxiety") -> dimensions

dimensions |> purrr::map(function(nm) {
  dat |>
    dplyr::mutate(x = dat[[nm]] - 1) -> df

  brm(bf(x | trials(4) ~ sex + age + surveyID + (1|respondentID),
         zi ~ surveyID + (1|respondentID)), data = df,
      family = zero_inflated_binomial) -> fit
  list(data = df, model = fit)
}) -> lst
#df
#posterior_predict(brms_fit, ndraws = 10, newdata = as.data.frame(df))
qs::qsave(lst, "~/Downloads/brms_fit.qs")
```



## Introduction

Lorem ipsum dolor sit amet, mollis gravida dictum mauris enim. Ut, vel cum,
commodo nulla at. Sed arcu euismod adipiscing, ut. In fames maximus mus nunc
velit mus sed ut primis et. Lorem vestibulum sed eu sit dolor risus. A, tempus
ac dui nullam, ut, est et sed quis. Nec eros. Varius condimentum ut ligula
vel vitae parturient erat diam. At convallis. Pharetra interdum diam congue
scelerisque et nisi egestas id pharetra. Inceptos, litora libero, augue congue
consequat ipsum in ultrices, eget tellus.

Amet, donec urna luctus cursus varius ante. Ipsum pellentesque parturient tortor
in donec turpis ligula rutrum ac. Augue auctor cursus justo litora placerat est
montes sed! Torquent velit a tincidunt. Fermentum conubia laoreet. Porta eu sed,
lobortis consectetur hendrerit eget, mauris nulla cum justo. Lorem per rutrum
cras inceptos tempus et amet sit quis aenean diam. Torquent non felis sodales
scelerisque, pharetra mi rutrum.

## Overview of data

Consectetur libero morbi nisl sapien. At a lorem imperdiet id. Proin suspendisse
purus sapien aliquam sed ac ante eu pellentesque. Et massa tempus sed diam
aenean, quis augue. Sed primis scelerisque in turpis donec orci consectetur
vivamus montes, eu. Et elementum. Amet proin augue quisque vitae dui sed sed
primis sed. Ac sed purus mauris a blandit. In elementum tempor lacinia in vitae
cras a dictumst, nisi odio. Blandit potenti donec.

Eget ultricies in. Lectus nec ridiculus lobortis nunc dis. Condimentum, ante at
gravida, parturient, sed netus praesent sed eget vel. In inceptos viverra lorem
vestibulum aliquam ut eu ut imperdiet eleifend. Dictumst cras fusce egestas
pellentesque sociis. Placerat vestibulum imperdiet sed, duis ipsum. Cum mollis
non facilisis facilisis non, viverra a vehicula. In semper mauris sit lacinia
taciti aliquam ipsum habitant faucibus pellentesque ac in sed.

## Descriptive analysis

Ut et aenean aptent vestibulum metus auctor non. Vel, pellentesque aptent mi
penatibus sit ex. Tincidunt dui ut aliquam non, fermentum quisque at ligula
justo. Faucibus ipsum ut sed dui tellus. Nibh augue fermentum metus sed sed
accumsan egestas dui. Id nec lectus nascetur, cursus nascetur purus. Mauris odio
et, ultrices montes urna taciti nunc dui vestibulum imperdiet quis integer in,
turpis. Aliquam, ac ut, tincidunt at tempus eu mattis condimentum nisl. Faucibus
quam egestas magna amet amet sed id ut, quisque.

## Modelling of utilities

Nibh turpis et, iaculis mus habitant egestas penatibus odio. Turpis lacus
scelerisque nulla condimentum, aliquam ut dignissim ullamcorper sed habitant. In
sapien erat viverra cras metus egestas in. Enim, phasellus a a ante nibh, nibh.
Eleifend justo per sit risus dolor. Non odio, non mauris porttitor interdum
aenean, dapibus luctus amet, sem venenatis. Est amet mauris interdum ridiculus
tristique morbi et vitae. Congue accumsan a iaculis, ut mauris non inceptos,
nisi dignissim. Neque est sit elementum lobortis, sed sed et. Tortor, blandit
sociosqu suspendisse consectetur neque sociosqu eros phasellus tincidunt lorem.
Non egestas, cursus potenti, ultricies interdum, quam egestas. Ut, fringilla
augue in, vehicula et nam, nunc.

Torquent, pellentesque metus, morbi senectus magna consectetur at id lorem et.
Quis, efficitur commodo commodo eu eget. Ut nunc. Tempor nec habitant, ut ornare
suspendisse in et ut. Risus id lacinia blandit vestibulum dui vehicula, cubilia
sed, sed. Non in, lacus turpis potenti elit. In dolor sit fermentum purus
viverra. Vitae velit, lacus. Et mattis praesent eros turpis nisl amet metus.
Laoreet litora nec aenean euismod sagittis. Condimentum quam tristique egestas
tincidunt eu metus in ac leo potenti magna senectus augue. In in nibh auctor
maximus sed tortor cubilia sodales. Mauris volutpat justo risus diam aliquam at
libero. Nisi cum sollicitudin felis senectus conubia.

## Final Analysis

Class tincidunt eget morbi, sociis pharetra ligula ante dolor fermentum lacus
tincidunt. Elit, at semper donec. Urna mollis sem ipsum turpis morbi risus
pulvinar. Laoreet leo vel praesent tristique non. Sed porttitor ac orci, cursus
montes quis ut. Rhoncus, integer conubia nibh risus vehicula sollicitudin magna.
Amet mattis sodales faucibus vulputate, porttitor vel mattis quis in. Ligula
faucibus molestie varius, fringilla habitasse primis ut. Massa magna eget ex
quam, metus aliquet viverra, euismod nec, dignissim nulla torquent? Et sit
luctus cras est et rutrum nec quis. Ut ultricies consequat habitasse nostra
conubia et tempor venenatis, iaculis lacus netus. Volutpat tincidunt tortor
viverra fames platea augue quis. Mollis, potenti in nisi gravida.

## Conclusion

Nunc augue scelerisque habitasse mi, eros sit, mollis. Risus primis ad vitae
tellus sociosqu quis, auctor ut vel nostra. Vestibulum morbi ut tempor justo
nibh convallis adipiscing nibh ut! Platea suscipit sed vestibulum in eu vitae,
conubia pharetra. Tincidunt, eget massa mauris laoreet, vel, quam ut sodales
iaculis. Et magnis ut, sed libero at quis vitae. Sed ridiculus, id platea ligula
cubilia taciti inceptos, habitant nibh tempor sed cubilia, lorem. Nisl feugiat
dapibus conubia nulla ut aenean et.
